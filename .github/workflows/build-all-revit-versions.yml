name: Build All Revit Versions

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  build:
    name: Build Revit ${{ matrix.revit-version }}
    runs-on: windows-latest
    
    strategy:
      matrix:
        revit-version: ['2020', '2021', '2022', '2023', '2024', '2025', '2026']
        configuration: ['Release']
      fail-fast: false  # Ti·∫øp t·ª•c build c√°c version kh√°c n·∫øu 1 version fail
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    
    - name: Restore NuGet packages
      working-directory: Quoc_Mep
      run: nuget restore Quoc_MEP.csproj -PackagesDirectory packages
    
    - name: Build for Revit ${{ matrix.revit-version }}
      working-directory: Quoc_Mep
      run: |
        msbuild Quoc_MEP.csproj `
          /t:Rebuild `
          /p:RevitVersion=${{ matrix.revit-version }} `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=AnyCPU `
          /maxcpucount `
          /verbosity:minimal
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP-Revit${{ matrix.revit-version }}-${{ matrix.configuration }}
        path: |
          Quoc_Mep/bin/${{ matrix.configuration }}/Revit${{ matrix.revit-version }}/**/*
          Quoc_Mep/bin/${{ matrix.configuration }}/**/*.dll
          Quoc_Mep/bin/${{ matrix.configuration }}/**/*.addin
        retention-days: 30
        if-no-files-found: warn

  # Build Loader (minimal, ch·∫°y tr√™n t·∫•t c·∫£ versions)
  build-loader:
    name: Build Universal Loader
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    
    - name: Restore NuGet packages
      working-directory: Quoc_Mep
      run: nuget restore Quoc_MEP.csproj -PackagesDirectory packages
    
    - name: Build Loader (Revit 2024 base)
      working-directory: Quoc_Mep
      run: |
        msbuild Quoc_MEP.csproj `
          /t:Rebuild `
          /p:RevitVersion=2024 `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:OutputPath=bin\Release\Loader\ `
          /maxcpucount `
          /verbosity:minimal
    
    - name: Upload loader artifact
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP_Loader
        path: |
          Quoc_Mep/bin/Release/Loader/Quoc_MEP_Loader.dll
          Quoc_Mep/Quoc_MEP_Universal.addin
        retention-days: 30

  # Job ri√™ng ƒë·ªÉ t·ªïng h·ª£p t·∫•t c·∫£ artifacts
  package-all:
    name: Package Universal Installation
    needs: [build, build-loader]
    runs-on: windows-latest
    
    steps:
    - name: Checkout code (for scripts)
      uses: actions/checkout@v4
    
    - name: Download all version artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create universal package structure
      shell: pwsh
      run: |
        $packageDir = "Quoc_MEP_Universal"
        New-Item -ItemType Directory -Force -Path $packageDir
        
        # Copy loader files v√†o th∆∞ m·ª•c g·ªëc
        if (Test-Path "artifacts\Quoc_MEP_Loader") {
          Copy-Item "artifacts\Quoc_MEP_Loader\*" -Destination $packageDir -Force
        }
        
        # Copy t·ª´ng phi√™n b·∫£n v√†o th∆∞ m·ª•c con
        $versions = @("2020", "2021", "2022", "2023", "2024", "2025", "2026")
        foreach ($ver in $versions) {
          $artifactName = "Quoc_MEP-Revit$ver-Release"
          $versionDir = "$packageDir\Revit$ver"
          
          if (Test-Path "artifacts\$artifactName") {
            New-Item -ItemType Directory -Force -Path $versionDir
            
            # Copy DLL v√† dependencies
            Get-ChildItem -Path "artifacts\$artifactName" -Recurse -File | Where-Object {
              $_.Extension -eq ".dll" -or $_.Extension -eq ".pdb"
            } | ForEach-Object {
              Copy-Item $_.FullName -Destination $versionDir -Force
            }
            
            # Copy Resources folder n·∫øu c√≥
            $resourcesPath = "artifacts\$artifactName\Resources"
            if (Test-Path $resourcesPath) {
              Copy-Item $resourcesPath -Destination "$versionDir\Resources" -Recurse -Force
            }
            
            Write-Host "‚úÖ Packaged Revit $ver"
          } else {
            Write-Host "‚ö†Ô∏è  Revit $ver artifacts not found"
          }
        }
        
        # T·∫°o README chi ti·∫øt
        @"
        # Quoc MEP Add-in - Universal Installation
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
        
        ## üöÄ C√†i ƒë·∫∑t ƒë∆°n gi·∫£n - Ch·ªâ 3 b∆∞·ªõc!
        
        ### B∆∞·ªõc 1: Copy to√†n b·ªô th∆∞ m·ª•c
        Copy to√†n b·ªô th∆∞ m·ª•c n√†y v√†o:
        
            %APPDATA%\Autodesk\Revit\Addins\
        
        ### B∆∞·ªõc 2: ƒê·ªïi t√™n th∆∞ m·ª•c
        ƒê·ªïi t√™n th∆∞ m·ª•c th√†nh t√™n phi√™n b·∫£n Revit c·ªßa b·∫°n:
        - Revit 2020 ‚Üí 2020
        - Revit 2021 ‚Üí 2021
        - Revit 2022 ‚Üí 2022
        - Revit 2023 ‚Üí 2023
        - Revit 2024 ‚Üí 2024
        - Revit 2025 ‚Üí 2025
        - Revit 2026 ‚Üí 2026
        
        ### B∆∞·ªõc 3: Restart Revit
        Kh·ªüi ƒë·ªông l·∫°i Revit v√† t·∫≠n h∆∞·ªüng!
        
        ## üìÅ C·∫•u tr√∫c th∆∞ m·ª•c sau khi c√†i:
        
        %APPDATA%\Autodesk\Revit\Addins\2024\
        ‚îú‚îÄ‚îÄ Quoc_MEP_Universal.addin    ‚Üê File addin ch√≠nh
        ‚îú‚îÄ‚îÄ Quoc_MEP_Loader.dll         ‚Üê Loader t·ª± ƒë·ªông
        ‚îî‚îÄ‚îÄ Revit2024\                  ‚Üê DLL cho version n√†y
            ‚îú‚îÄ‚îÄ Quoc_MEP.dll
            ‚îú‚îÄ‚îÄ Resources\
            ‚îî‚îÄ‚îÄ (c√°c dependencies kh√°c)
        
        ## üéØ C√°ch ho·∫°t ƒë·ªông:
        
        1. File .addin load Quoc_MEP_Loader.dll
        2. Loader t·ª± ƒë·ªông detect phi√™n b·∫£n Revit
        3. Load ƒë√∫ng DLL t·ª´ th∆∞ m·ª•c Revit{Version}
        4. Add-in ch·∫°y b√¨nh th∆∞·ªùng!
        
        ## ‚ú® T√≠nh nƒÉng:
        
        - ‚úÖ T·ª± ƒë·ªông detect phi√™n b·∫£n Revit
        - ‚úÖ 1 l·∫ßn c√†i ƒë·∫∑t cho t·∫•t c·∫£ versions
        - ‚úÖ D·ªÖ d√†ng update (ch·ªâ replace files)
        - ‚úÖ H·ªó tr·ª£ Revit 2020-2026
        
        ## üì¶ Included Versions:
        - Revit 2020 (.NET 4.8)
        - Revit 2021 (.NET 4.8)
        - Revit 2022 (.NET 4.8)
        - Revit 2023 (.NET 4.8)
        - Revit 2024 (.NET 4.8)
        - Revit 2025 (.NET 8.0)
        - Revit 2026 (.NET 8.0)
        
        ## üÜò Troubleshooting:
        
        N·∫øu g·∫∑p l·ªói, ki·ªÉm tra:
        1. File Quoc_MEP_Universal.addin ·ªü ƒë√∫ng v·ªã tr√≠
        2. Th∆∞ m·ª•c Revit{Version} t·ªìn t·∫°i
        3. File Quoc_MEP.dll trong th∆∞ m·ª•c version
        
        "@ | Out-File -FilePath "$packageDir\README.txt" -Encoding UTF8
        
        # T·∫°o install script t·ª± ƒë·ªông
        @"
        @echo off
        echo ================================================
        echo   Quoc MEP Universal Installer
        echo ================================================
        echo.
        
        set "ADDIN_PATH=%APPDATA%\Autodesk\Revit\Addins"
        
        echo Chon phien ban Revit cua ban:
        echo 1. Revit 2020
        echo 2. Revit 2021
        echo 3. Revit 2022
        echo 4. Revit 2023
        echo 5. Revit 2024
        echo 6. Revit 2025
        echo 7. Revit 2026
        echo.
        
        set /p choice="Nhap so (1-7): "
        
        if "%choice%"=="1" set "VERSION=2020"
        if "%choice%"=="2" set "VERSION=2021"
        if "%choice%"=="3" set "VERSION=2022"
        if "%choice%"=="4" set "VERSION=2023"
        if "%choice%"=="5" set "VERSION=2024"
        if "%choice%"=="6" set "VERSION=2025"
        if "%choice%"=="7" set "VERSION=2026"
        
        if not defined VERSION (
            echo Lua chon khong hop le!
            pause
            exit /b 1
        )
        
        set "DEST=%ADDIN_PATH%\%VERSION%"
        
        echo.
        echo Dang cai dat vao: %DEST%
        echo.
        
        if not exist "%DEST%" mkdir "%DEST%"
        
        xcopy /Y /E /I "%~dp0*" "%DEST%\"
        
        echo.
        echo ================================================
        echo   Cai dat thanh cong!
        echo ================================================
        echo.
        echo Khoi dong lai Revit %VERSION% de su dung.
        echo.
        pause
        "@ | Out-File -FilePath "$packageDir\INSTALL.bat" -Encoding ASCII
    
    - name: Compress package
      shell: pwsh
      run: |
        Compress-Archive -Path "Quoc_MEP_Universal\*" -DestinationPath "Quoc_MEP_Universal.zip" -Force
    
    - name: Upload universal package
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP_Universal_Package
        path: Quoc_MEP_Universal.zip
        retention-days: 90

  # T·∫°o release n·∫øu c√≥ tag
  create-release:
    name: Create Release
    needs: package-all
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: Quoc_MEP_Universal_Package
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: Quoc_MEP_Universal.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
