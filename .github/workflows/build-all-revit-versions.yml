name: Build All Revit Versions

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  build:
    name: Build Revit ${{ matrix.revit-version }}
    runs-on: windows-latest
    
    strategy:
      matrix:
        revit-version: ['2020', '2021', '2022', '2023', '2024', '2025', '2026']
        configuration: ['Release']
      fail-fast: false  # Tiáº¿p tá»¥c build cÃ¡c version khÃ¡c náº¿u 1 version fail
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    
    - name: Restore NuGet packages  
      working-directory: Quoc_Mep
      run: |
        nuget restore packages.config -PackagesDirectory packages
        nuget restore Quoc_MEP_Main.sln
    
    - name: Build for Revit ${{ matrix.revit-version }}
      working-directory: Quoc_Mep
      run: |
        msbuild Quoc_MEP.csproj `
          /t:Rebuild `
          /p:RevitVersion=${{ matrix.revit-version }} `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=AnyCPU `
          /maxcpucount `
          /verbosity:minimal
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP-Revit${{ matrix.revit-version }}-${{ matrix.configuration }}
        path: |
          Quoc_Mep/bin/${{ matrix.configuration }}/Revit${{ matrix.revit-version }}/**/*
          Quoc_Mep/bin/${{ matrix.configuration }}/**/*.dll
          Quoc_Mep/bin/${{ matrix.configuration }}/**/*.addin
        retention-days: 30
        if-no-files-found: warn

  # Build Loader (minimal, cháº¡y trÃªn táº¥t cáº£ versions)
  build-loader:
    name: Build Universal Loader
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    
    - name: Restore NuGet packages
      working-directory: Quoc_Mep
      run: |
        nuget restore packages.config -PackagesDirectory packages
        nuget restore Quoc_MEP_Main.sln
    
    - name: Build Loader (Revit 2024 base)
      working-directory: Quoc_Mep
      run: |
        msbuild Quoc_MEP.csproj `
          /t:Rebuild `
          /p:RevitVersion=2024 `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:OutputPath=bin\Release\Loader\ `
          /maxcpucount `
          /verbosity:minimal
    
    - name: Upload loader artifact
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP_Loader
        path: |
          Quoc_Mep/bin/Release/Loader/Quoc_MEP_Loader.dll
          Quoc_Mep/Quoc_MEP_Universal.addin
        retention-days: 30

  # Job riÃªng Ä‘á»ƒ tá»•ng há»£p táº¥t cáº£ artifacts
  package-all:
    name: Package Universal Installation
    needs: [build, build-loader]
    runs-on: windows-latest
    
    steps:
    - name: Checkout code (for scripts)
      uses: actions/checkout@v4
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    
    - name: Download a single build artifact for builders
      uses: actions/download-artifact@v4
      with:
        name: Quoc_MEP-Revit2024-Release
        path: BuilderArtifacts
    
    - name: Generate PackageContents.xml using builder
      shell: pwsh
      run: |
        # Error handling
        $ErrorActionPreference = "Stop"
        
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘  Autodesk Package Manifest Generation                   â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        
        # [1/4] Locate assemblies
        Write-Host "`n[1/4] ğŸ” Locating builder assemblies..." -ForegroundColor Yellow
        
        $assemblyPath = Get-ChildItem -Path "BuilderArtifacts" -Filter "Quoc_MEP.dll" -Recurse -ErrorAction Stop | Select-Object -First 1
        if (-not $assemblyPath) {
          throw "Quoc_MEP.dll not found in BuilderArtifacts"
        }
        Write-Host "      âœ“ Quoc_MEP.dll: $($assemblyPath.FullName)" -ForegroundColor Green
        
        $packageBuilderPath = Get-ChildItem -Path (Split-Path $assemblyPath.FullName) -Filter "Autodesk.PackageBuilder.dll" -ErrorAction Stop | Select-Object -First 1
        if (-not $packageBuilderPath) {
          throw "Autodesk.PackageBuilder.dll not found"
        }
        Write-Host "      âœ“ PackageBuilder: $($packageBuilderPath.FullName)" -ForegroundColor Green
        
        # [2/4] Load assemblies
        Write-Host "`n[2/4] ğŸ“š Loading .NET assemblies..." -ForegroundColor Yellow
        try {
          Add-Type -Path $packageBuilderPath.FullName
          Add-Type -Path $assemblyPath.FullName
          Write-Host "      âœ“ Assemblies loaded successfully" -ForegroundColor Green
        }
        catch {
          Write-Host "      âœ— Failed to load assemblies: $_" -ForegroundColor Red
          throw
        }
        
        # Create output directory
        New-Item -ItemType Directory -Force -Path "GeneratedFiles" | Out-Null
        
        # [3/4] Generate PackageContents.xml
        Write-Host "`n[3/4] ğŸ“¦ Generating PackageContents.xml..." -ForegroundColor Yellow
        try {
          $version = if ($env:GITHUB_REF -match 'refs/tags/v(.+)') { $matches[1] } else { "1.0.0" }
          $builder = New-Object Quoc_MEP.Builders.QuocMEPPackageBuilder($version)
          $packageXml = "GeneratedFiles\PackageContents.xml"
          $null = $builder.Build($packageXml)
          
          Write-Host "      âœ“ PackageContents.xml generated" -ForegroundColor Green
          Write-Host "      â„¹ Version: $version" -ForegroundColor Gray
          Write-Host "      â„¹ Output: $packageXml" -ForegroundColor Gray
        }
        catch {
          Write-Host "      âœ— Generation failed: $_" -ForegroundColor Red
          throw
        }
        
        # [4/4] Generate Quoc_MEP.addin
        Write-Host "`n[4/4] ğŸ“ Generating Quoc_MEP.addin manifest..." -ForegroundColor Yellow
        try {
          $addinBuilder = New-Object Quoc_MEP.Builders.QuocMEPAddinBuilder
          $addinFile = "GeneratedFiles\Quoc_MEP.addin"
          $null = $addinBuilder.Build($addinFile)
          
          Write-Host "      âœ“ Quoc_MEP.addin generated" -ForegroundColor Green
          Write-Host "      â„¹ Output: $addinFile" -ForegroundColor Gray
        }
        catch {
          Write-Host "      âœ— Generation failed: $_" -ForegroundColor Red
          throw
        }
        
        Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘  âœ“ Manifest Generation Completed Successfully           â•‘" -ForegroundColor Green
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
    
    - name: Download all version artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create universal package structure
      shell: pwsh
      run: |
        $packageDir = "Quoc_MEP_Universal"
        New-Item -ItemType Directory -Force -Path $packageDir
        
        # Copy generated package files from Autodesk.PackageBuilder
        Write-Host "ğŸ“¦ Copying generated PackageContents.xml..." -ForegroundColor Cyan
        if (Test-Path "GeneratedFiles\PackageContents.xml") {
          Copy-Item "GeneratedFiles\PackageContents.xml" -Destination $packageDir -Force
          Write-Host "âœ… PackageContents.xml copied" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸  PackageContents.xml not found in GeneratedFiles" -ForegroundColor Yellow
        }
        
        # Copy loader files vÃ o thÆ° má»¥c gá»‘c
        if (Test-Path "artifacts\Quoc_MEP_Loader") {
          Copy-Item "artifacts\Quoc_MEP_Loader\*" -Destination $packageDir -Force
        }
        
        # Copy tá»«ng phiÃªn báº£n vÃ o thÆ° má»¥c con
        $versions = @("2020", "2021", "2022", "2023", "2024", "2025", "2026")
        foreach ($ver in $versions) {
          $artifactName = "Quoc_MEP-Revit$ver-Release"
          $versionDir = "$packageDir\Revit$ver"
          
          if (Test-Path "artifacts\$artifactName") {
            New-Item -ItemType Directory -Force -Path $versionDir
            
            # Copy DLL vÃ  dependencies
            Get-ChildItem -Path "artifacts\$artifactName" -Recurse -File | Where-Object {
              $_.Extension -eq ".dll" -or $_.Extension -eq ".pdb"
            } | ForEach-Object {
              Copy-Item $_.FullName -Destination $versionDir -Force
            }
            
            # Copy Resources folder náº¿u cÃ³
            $resourcesPath = "artifacts\$artifactName\Resources"
            if (Test-Path $resourcesPath) {
              Copy-Item $resourcesPath -Destination "$versionDir\Resources" -Recurse -Force
            }
            
            # Copy generated .addin file for this version
            if (Test-Path "GeneratedFiles\Quoc_MEP.addin") {
              Copy-Item "GeneratedFiles\Quoc_MEP.addin" -Destination $versionDir -Force
            }
            
            Write-Host "âœ… Packaged Revit $ver"
          } else {
            Write-Host "âš ï¸  Revit $ver artifacts not found"
          }
        }
        
        # Táº¡o README chi tiáº¿t
        @"
        # Quoc MEP Add-in - Universal Installation
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
        
        ## ğŸš€ CÃ i Ä‘áº·t Ä‘Æ¡n giáº£n - Chá»‰ 3 bÆ°á»›c!
        
        ### BÆ°á»›c 1: Copy toÃ n bá»™ thÆ° má»¥c
        Copy toÃ n bá»™ thÆ° má»¥c nÃ y vÃ o:
        
            %APPDATA%\Autodesk\Revit\Addins\
        
        ### BÆ°á»›c 2: Äá»•i tÃªn thÆ° má»¥c
        Äá»•i tÃªn thÆ° má»¥c thÃ nh tÃªn phiÃªn báº£n Revit cá»§a báº¡n:
        - Revit 2020 â†’ 2020
        - Revit 2021 â†’ 2021
        - Revit 2022 â†’ 2022
        - Revit 2023 â†’ 2023
        - Revit 2024 â†’ 2024
        - Revit 2025 â†’ 2025
        - Revit 2026 â†’ 2026
        
        ### BÆ°á»›c 3: Restart Revit
        Khá»Ÿi Ä‘á»™ng láº¡i Revit vÃ  táº­n hÆ°á»Ÿng!
        
        ## ğŸ“ Cáº¥u trÃºc thÆ° má»¥c sau khi cÃ i:
        
        %APPDATA%\Autodesk\Revit\Addins\2024\
        â”œâ”€â”€ Quoc_MEP_Universal.addin    â† File addin chÃ­nh
        â”œâ”€â”€ Quoc_MEP_Loader.dll         â† Loader tá»± Ä‘á»™ng
        â””â”€â”€ Revit2024\                  â† DLL cho version nÃ y
            â”œâ”€â”€ Quoc_MEP.dll
            â”œâ”€â”€ Resources\
            â””â”€â”€ (cÃ¡c dependencies khÃ¡c)
        
        ## ğŸ¯ CÃ¡ch hoáº¡t Ä‘á»™ng:
        
        1. File .addin load Quoc_MEP_Loader.dll
        2. Loader tá»± Ä‘á»™ng detect phiÃªn báº£n Revit
        3. Load Ä‘Ãºng DLL tá»« thÆ° má»¥c Revit{Version}
        4. Add-in cháº¡y bÃ¬nh thÆ°á»ng!
        
        ## âœ¨ TÃ­nh nÄƒng:
        
        - âœ… Tá»± Ä‘á»™ng detect phiÃªn báº£n Revit
        - âœ… 1 láº§n cÃ i Ä‘áº·t cho táº¥t cáº£ versions
        - âœ… Dá»… dÃ ng update (chá»‰ replace files)
        - âœ… Há»— trá»£ Revit 2020-2026
        
        ## ğŸ“¦ Included Versions:
        - Revit 2020 (.NET 4.8)
        - Revit 2021 (.NET 4.8)
        - Revit 2022 (.NET 4.8)
        - Revit 2023 (.NET 4.8)
        - Revit 2024 (.NET 4.8)
        - Revit 2025 (.NET 8.0)
        - Revit 2026 (.NET 8.0)
        
        ## ğŸ†˜ Troubleshooting:
        
        Náº¿u gáº·p lá»—i, kiá»ƒm tra:
        1. File Quoc_MEP_Universal.addin á»Ÿ Ä‘Ãºng vá»‹ trÃ­
        2. ThÆ° má»¥c Revit{Version} tá»“n táº¡i
        3. File Quoc_MEP.dll trong thÆ° má»¥c version
        
        "@ | Out-File -FilePath "$packageDir\README.txt" -Encoding UTF8
        
        # Táº¡o install script tá»± Ä‘á»™ng
        @"
        @echo off
        echo ================================================
        echo   Quoc MEP Universal Installer
        echo ================================================
        echo.
        
        set "ADDIN_PATH=%APPDATA%\Autodesk\Revit\Addins"
        
        echo Chon phien ban Revit cua ban:
        echo 1. Revit 2020
        echo 2. Revit 2021
        echo 3. Revit 2022
        echo 4. Revit 2023
        echo 5. Revit 2024
        echo 6. Revit 2025
        echo 7. Revit 2026
        echo.
        
        set /p choice="Nhap so (1-7): "
        
        if "%choice%"=="1" set "VERSION=2020"
        if "%choice%"=="2" set "VERSION=2021"
        if "%choice%"=="3" set "VERSION=2022"
        if "%choice%"=="4" set "VERSION=2023"
        if "%choice%"=="5" set "VERSION=2024"
        if "%choice%"=="6" set "VERSION=2025"
        if "%choice%"=="7" set "VERSION=2026"
        
        if not defined VERSION (
            echo Lua chon khong hop le!
            pause
            exit /b 1
        )
        
        set "DEST=%ADDIN_PATH%\%VERSION%"
        
        echo.
        echo Dang cai dat vao: %DEST%
        echo.
        
        if not exist "%DEST%" mkdir "%DEST%"
        
        xcopy /Y /E /I "%~dp0*" "%DEST%\"
        
        echo.
        echo ================================================
        echo   Cai dat thanh cong!
        echo ================================================
        echo.
        echo Khoi dong lai Revit %VERSION% de su dung.
        echo.
        pause
        "@ | Out-File -FilePath "$packageDir\INSTALL.bat" -Encoding ASCII
    
    - name: Compress package
      shell: pwsh
      run: |
        Compress-Archive -Path "Quoc_MEP_Universal\*" -DestinationPath "Quoc_MEP_Universal.zip" -Force
    
    - name: Upload universal package
      uses: actions/upload-artifact@v4
      with:
        name: Quoc_MEP_Universal_Package
        path: Quoc_MEP_Universal.zip
        retention-days: 90

  # Táº¡o release náº¿u cÃ³ tag
  create-release:
    name: Create Release
    needs: package-all
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: Quoc_MEP_Universal_Package
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: Quoc_MEP_Universal.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
